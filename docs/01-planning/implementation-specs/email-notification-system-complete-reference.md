# Email & Notification System - Complete Reference
**Status**: Planning
**Created**: 2025-09-30
**Last Updated**: 2025-09-30 (Updated with executive sender assignments and voice profiles)

---

## Overview

This document provides a comprehensive reference for all notification and email systems in Music Label Manager, including:
- Current toast notification implementation
- Planned email system architecture
- Event tracking across the game engine
- File references and data structures
- Implementation strategy

---

## System Architecture

### Design Philosophy: Hybrid Approach (Option C)

**Toasts** = Immediate feedback (ephemeral, real-time)
**Emails** = Detailed context + historical record (persistent, narrative)

- **Toasts**: Instant gratification for state changes (money, reputation, creative capital)
- **Emails**: CEO roleplay immersion with detailed reports from your team

---

## Current Toast Notification System

### File Reference
**Primary Implementation**: `client/src/components/ToastNotification.tsx`

**Dependencies**:
- `@/components/ui/toaster` - Shadcn UI toast component
- `@/components/ui/toast` - Toast primitive + actions
- `@/hooks/use-toast` - Toast state management hook
- `@/store/gameStore` - Zustand game state store

### Toast Categories (Currently Implemented)

#### 1. Real-Time State Change Toasts
**Trigger**: `useEffect` watching `gameState` changes

##### Money Changes (`client/src/components/ToastNotification.tsx:94-121`)
```typescript
// Watches: gameState.money
// Type: Revenue (positive) | Expense (negative)
// Display:
//   - Title: "💰 Revenue $X" or "💸 Expense $X"
//   - Description: Current balance + low funds warning
//   - Action: "View Budget" (if balance < $5,000)
```

**Data Source**: `gameState.money` (updated by game engine)

##### Reputation Changes (`client/src/components/ToastNotification.tsx:123-145`)
```typescript
// Watches: gameState.reputation
// Display:
//   - Title: "⭐ Reputation +X" or "📉 Reputation -X"
//   - Description: Current rep + tier (Elite/Established/Rising/Emerging/Unknown)
//   - Progress: Visual bar showing reputation %
```

**Reputation Tiers**:
- Elite: 80+
- Established: 60-79
- Rising: 40-59
- Emerging: 20-39
- Unknown: 0-19

**Data Source**: `gameState.reputation` (updated by game engine)

##### Creative Capital Changes (`client/src/components/ToastNotification.tsx:147-164`)
```typescript
// Watches: gameState.creativeCapital
// Display:
//   - Title: "💡 Creative Capital +X" or "🔥 Creative Capital -X"
//   - Description: Current CC + celebration if >= 80
//   - Progress: Visual bar showing CC %
```

**Data Source**: `gameState.creativeCapital` (updated by game engine)

---

#### 2. Weekly Outcome Toasts
**Trigger**: `useEffect` watching `weeklyOutcome.changes` array

##### Project Completions (`client/src/components/ToastNotification.tsx:193-213`)
```typescript
// Filter: changes.filter(c => c.type === 'project_complete')
// Display:
//   - Title: "🎵 Recording Complete!"
//   - Description: "{Project Title} songs are recorded and ready for release"
//   - Action: "View Details"
// Timing: Staggered by 1.5s per project if multiple
```

**Data Source**: `weeklyOutcome.changes[]` with `type: 'project_complete'`
**Generated By**: `shared/engine/game-engine.ts` in `processWeek()`

##### Streaming Revenue (`client/src/components/ToastNotification.tsx:215-236`)
```typescript
// Filter: changes.filter(c => c.type === 'revenue' && c.description.includes('Streaming'))
// Display:
//   - Title: "💿 Streaming Success!"
//   - Description: "Your releases generated $X from streaming this week!"
//   - Action: "View Analytics"
// Aggregation: Sums all streaming revenue changes
```

**Data Source**: `weeklyOutcome.changes[]` with `type: 'revenue'`
**Generated By**: `shared/engine/game-engine.ts` (streaming calculations)

##### Achievement/Unlock Notifications (`client/src/components/ToastNotification.tsx:238-254`)
```typescript
// Filter: changes.filter(c => c.type === 'unlock')
// Display:
//   - Title: "🏆 New Achievement!"
//   - Description: change.description
//   - Action: "Celebrate"
```

**Data Source**: `weeklyOutcome.changes[]` with `type: 'unlock'`
**Generated By**: Multiple locations in `shared/engine/game-engine.ts`:
- Focus slot unlocks
- Tier unlocks (playlist, press, venue)
- Song recording completions

##### Artist Mood Changes (`client/src/components/ToastNotification.tsx:256-275`)
```typescript
// Filter: changes.filter(c => c.type === 'mood' && c.description.includes('meeting decision'))
// Display:
//   - Title: "😊 Artist Morale Improved" or "😔 Artist Morale Declined"
//   - Description: "Executive meeting decision boosted/lowered all artists' mood by X points"
//   - Action: "View Artists"
```

**Data Source**: `weeklyOutcome.changes[]` with `type: 'mood'`
**Generated By**: Executive meeting system (applies to all artists)

##### Artist Loyalty Changes (`client/src/components/ToastNotification.tsx:277-296`)
```typescript
// Filter: changes.filter(c => c.type === 'mood' && c.loyaltyBoost && c.description.includes('meeting decision'))
// Display:
//   - Title: "💖 Artist Loyalty Increased" or "💔 Artist Loyalty Decreased"
//   - Description: "Executive meeting decision strengthened/weakened loyalty by X points"
//   - Action: "View Artists"
```

**Data Source**: `weeklyOutcome.changes[]` with `type: 'mood'` + `loyaltyBoost` field
**Generated By**: Executive meeting system

##### Busy Week Summary (`client/src/components/ToastNotification.tsx:298-315`)
```typescript
// Trigger: If weeklyOutcome.changes.length >= 3
// Display:
//   - Title: "📊 Busy Week!"
//   - Description: "{X} significant events occurred this week"
//   - Action: "View Summary"
```

**Data Source**: `weeklyOutcome.changes[]` array length
**Timing**: Shown 5s after weekly outcome processing

---

## Game Event Tracking System

### Core Data Types

#### GameChange Type (`shared/types/gameTypes.ts`)
```typescript
export interface GameChange {
  type: 'expense' | 'revenue' | 'meeting' | 'project_complete' | 'delayed_effect' |
        'unlock' | 'ongoing_revenue' | 'song_release' | 'release' | 'marketing' |
        'reputation' | 'error' | 'mood' | 'popularity' | 'executive_interaction' |
        'expense_tracking' | 'breakthrough' | 'awareness_gain' | 'awareness_decay';
  description: string;
  amount?: number;
  roleId?: string;
  projectId?: string;
  moodChange?: number;
  newMood?: number;
  loyaltyBoost?: number;
  newLoyalty?: number;
  source?: string;
  artistId?: string;
}
```

#### WeekSummary Type (`shared/types/gameTypes.ts`)
```typescript
export interface WeekSummary {
  week: number;
  changes: GameChange[];
  revenue: number;
  expenses: number;
  streams?: number;
  reputationChanges: Record<string, number>;
  events: EventOccurrence[];
  artistChanges?: Record<string, number>;
  expenseBreakdown?: {
    weeklyOperations: number;
    artistSalaries: number;
    executiveSalaries: number;
    projectCosts: number;
    marketingCosts: number;
    roleMeetingCosts: number;
    // ... more fields
  };
  financialBreakdown?: string;
  chartUpdates?: ChartUpdate[]; // Chart position changes
  arOffice?: {
    completed: boolean;
    sourcingType?: 'active' | 'passive' | 'specialized' | null;
    discoveredArtistId?: string | null;
  };
}
```

#### ChartUpdate Type (`shared/types/gameTypes.ts`)
```typescript
export interface ChartUpdate {
  songTitle: string;
  artistName: string;
  position: number | null;
  movement?: number; // Positive = up, negative = down
  isDebut: boolean;
  weeksOnChart?: number;
  peakPosition?: number | null;
  isCompetitorSong?: boolean;
}
```

### Event Generation Sources

#### Game Engine (`shared/engine/game-engine.ts`)
**Primary event generator** - Creates all `GameChange` objects during `processWeek()`

**Key Event Generation Locations**:

1. **Project Completions** (Recording/Tours)
   - Location: `processWeek()` → project stage transitions
   - Type: `'project_complete'`
   - Tour completion: Lines ~800-850 (Mini-Tour handling)
   ```typescript
   changes.push({
     type: 'project_complete',
     description: `${project.title} tour completed - ${cities} cities, ${avgAttendance}% avg attendance, $${totalRevenue}`,
     amount: 0, // Revenue already counted weekly
     projectId: project.id
   });
   ```

2. **Unlock Events**
   - Focus slot unlocks (reputation thresholds)
   - Tier unlocks (playlist, press, venue access)
   - Song recording completions
   - Type: `'unlock'`
   - Location: Various points in `processWeek()`

3. **Revenue/Expense Events**
   - Streaming revenue: `'ongoing_revenue'` or `'revenue'`
   - Project costs: `'expense'`
   - Artist salaries: `'expense'`
   - Marketing costs: `'marketing'`

4. **Mood/Loyalty Changes**
   - Executive meeting decisions
   - Type: `'mood'`
   - Fields: `moodChange`, `newMood`, `loyaltyBoost`, `newLoyalty`

5. **A&R Office Discoveries**
   - Stored in: `WeekSummary.arOffice`
   - Contains: `discoveredArtistId`, `sourcingType`
   - Location: A&R Office processing logic

#### Chart Service (`shared/engine/ChartService.ts`)
**Chart position tracking** - Generates `ChartUpdate[]` array

**Chart Event Types**:
- Chart debuts (`isDebut: true`)
- Position changes (movement tracking)
- Peak position updates
- Competitor song tracking

**Integration**: Chart updates added to `WeekSummary.chartUpdates[]`

---

## Planned Email System

### Design Mockup
**Reference**: `docs/01-planning/email.PNG`

**UI Components**:
1. **Dashboard Inbox Widget** - Shows unread count, clickable to open modal
2. **Inbox Modal** - Two-column layout:
   - Left: Email list (Date/Subject sortable)
   - Right: Email content viewer
   - Actions: Mark as Read, Delete, Close (X)

### Executive Team - Email Senders
**Reference**: `data/roles.json`, `docs/01-planning/exec_team_context/Exec Team - Character Bible.md`

Your executive team will send emails based on their expertise areas:

1. **Marcus "Mac" Rodriguez** - Head of A&R (`head_ar`)
2. **Dante "D-Wave" Washington** - Chief Creative Officer (`cco`)
3. **Samara "Sam" Chen** - Chief Marketing Officer (`cmo`)
4. **Patricia "Pat" Williams, PhD** - Head of Distribution/Operations (`head_distribution`)
5. **Finance Team** - Generic sender for financial reports (CEO receives these)

#### Executive Voice Profiles

**Marcus "Mac" Rodriguez (Head of A&R)**
- **Speaking Style**: Musical metaphors, venue name-dropping, obscure references
- **Mood Indicators**: References "the one that got away" when stressed
- **Email Tone**: Passionate, slightly haunted by past mistakes, eager to prove himself

**Dante "D-Wave" Washington (CCO)**
- **Speaking Style**: Synesthesia language ("sounds purple"), philosophical, mystical
- **Mood Indicators**: Quotes frequencies and "the universe"
- **Email Tone**: Artistic, pretentious but talented, talks about "sonic architecture"

**Samara "Sam" Chen (CMO)**
- **Speaking Style**: Headlines, pull quotes, war metaphors, news cycle references
- **Mood Indicators**: "Own the narrative" vs "credibility debt"
- **Email Tone**: Strategic, aggressive, frames everything as a story to control

**Patricia "Pat" Williams, PhD (Distribution/Ops)**
- **Speaking Style**: Statistics, percentages, supply chain metaphors, if-then scenarios
- **Mood Indicators**: "Systems optimized" vs "Complete system failure"
- **Email Tone**: Data-driven, analytical, uncomfortable with inefficiency

---

### Email Categories (7 Total) - Sender Assignments

#### 1. Tour Completion Emails
**Sender**: Patricia "Pat" Williams, PhD (Head of Distribution/Operations)
**Trigger**: Mini-Tour projects reach completion stage

**Data Source**:
- `WeekSummary.changes[]` with `type: 'project_complete'`
- Filter: `project.type === 'Mini-Tour'`
- Metadata: `project.metadata.tourStats`

**Available Data**:
```typescript
{
  cities: [
    { name: string, revenue: number, attendance: number }
  ],
  totalRevenue: number,
  avgAttendance: number
}
```

**Email Template Concept** (Pat's voice - data-driven, efficiency-focused):
```
From: Patricia "Pat" Williams, PhD - Head of Distribution & Operations
Subject: Tour Metrics - [Artist Name] - [City Count] Cities Completed

Tour execution complete. Here are the performance metrics:

EFFICIENCY ANALYSIS:
• Cities: [X]
• Total Revenue: $[X]
• Average Attendance: [X]%
• Optimal Performance City: [City] - $[Revenue], [X]% capacity

ROI: [Calculated percentage]
System Efficiency Rating: [X]/100

The logistics pipeline is clear for the next deployment cycle.

- Pat
```

---

#### 2. Top 10 Chart Debut Emails
**Sender**: Samara "Sam" Chen (Chief Marketing Officer)
**Trigger**: Song enters chart at position 1-10

**Data Source**:
- `WeekSummary.chartUpdates[]`
- Filter: `chartUpdate.position <= 10 && chartUpdate.isDebut === true`

**Available Data**:
```typescript
{
  songTitle: string,
  artistName: string,
  position: number,
  isDebut: boolean
}
```

**Email Template Concept** (Sam's voice - narrative framing, headline-driven):
```
From: Samara "Sam" Chen - Chief Marketing Officer
Subject: HEADLINE: "[Song]" Debuts at #[Position] - Press Cycle Activated

We're in the narrative now.

"[Artist]'s '[Song]' Crashes Top 10 at #[Position]"

That's the headline. I've already got three journalists calling for quotes and two playlist editors asking about the story behind it. This isn't just a chart position—it's a conversation starter.

STRATEGIC WINDOW: 72 hours to capitalize before the news cycle shifts.

Next move is yours, but I'd strike while we own the moment.

- Sam
```

---

#### 3. Album/Single Release Emails
**Sender**: Patricia "Pat" Williams, PhD (Head of Distribution/Operations)
**Trigger**: Song released to charts

**Data Source**:
- `WeekSummary.changes[]` with `type: 'song_release'` or `'release'`

**Available Data**:
```typescript
{
  type: 'song_release' | 'release',
  description: string,
  projectId?: string
}
```

**Email Template Concept** (Pat's voice - system status, distribution metrics):
```
From: Patricia "Pat" Williams, PhD - Head of Distribution & Operations
Subject: Release Deployed - "[Song]" by [Artist] - Systems Green

Distribution pipeline executed successfully.

RELEASE STATUS:
• Track: "[Song]"
• Artist: [Artist]
• Platforms: All streaming services (100% uptime)
• Playlist Submissions: [X] based on current access tier
• Press Outlets: [X] publications notified
• Metadata Quality: Verified ✓

Initial streaming data will populate within 24-48 hours. All systems nominal.

- Pat
```

---

#### 4. #1 Chart Debut Emails
**Sender**: Samara "Sam" Chen (Chief Marketing Officer)
**Trigger**: Song enters chart at #1 position

**Data Source**:
- `WeekSummary.chartUpdates[]`
- Filter: `chartUpdate.position === 1 && chartUpdate.isDebut === true`

**Available Data**:
```typescript
{
  songTitle: string,
  artistName: string,
  position: 1,
  isDebut: boolean
}
```

**Email Template Concept** (Sam's voice - major cultural moment framing):
```
From: Samara "Sam" Chen - Chief Marketing Officer
Subject: 🏆 CULTURAL MOMENT ACHIEVED - "[Song]" #1 DEBUT

We just made history.

"[Artist]'s '[Song]' Debuts at #1 on the Charts"

Not top 10. Not climbing. NUMBER ONE on debut.

Every major outlet is already running the story. My phone hasn't stopped. This isn't PR anymore—this is legacy-building.

The narrative writes itself now, but we need to protect and amplify it. This moment is a weapon if we use it right.

I'm drafting the victory lap campaign. Greenlight?

- Sam

P.S. - Remember when I said we'd own the narrative? We OWN it now.
```

---

#### 5. New Tier Unlock Emails
**Sender**: Varies by tier type
**Trigger**: Reputation crosses tier threshold

**Data Source**:
- `WeekSummary.changes[]` with `type: 'unlock'`
- Filter: Description contains "Playlist Access" | "Press Access" | "Venue Access" | "Producer Tier"

**Available Data**:
```typescript
{
  type: 'unlock',
  description: string, // Contains tier name and level
  amount: 0
}
```

**Current Unlock Types & Senders**:
1. **Playlist Access** → Patricia "Pat" Williams, PhD (Distribution)
2. **Press Access** → Samara "Sam" Chen (CMO)
3. **Venue Access** → Patricia "Pat" Williams, PhD (Distribution)
4. **Producer Tier** → Dante "D-Wave" Washington (CCO)
5. **Focus Slots** → System notification (generic)

**Email Template Concepts**:

**Playlist Tier Unlock (Pat's voice)**:
```
From: Patricia "Pat" Williams, PhD - Head of Distribution & Operations
Subject: Distribution Tier Upgrade - [Tier Level] Playlists Unlocked

System access expanded.

NEW CAPABILITIES:
• [Tier Level] playlist network access
• Projected reach: [X] potential listeners
• Submission efficiency increased by [X]%

STRATEGIC IMPLICATIONS:
Your reputation score ([X]/100) has unlocked algorithmic partnerships with major streaming platforms. Recommendation systems will now prioritize our catalog.

ROI projection: [X]% increase in streaming revenue per release.

- Pat
```

**Press Tier Unlock (Sam's voice)**:
```
From: Samara "Sam" Chen - Chief Marketing Officer
Subject: Media Doors Opening - [Tier Level] Press Access Secured

The narrative just got louder.

NEW PRESS CONTACTS:
• [Tier Level] media outlets
• [X] new journalist relationships
• Coverage reach: [X] million readers

WHAT THIS MEANS:
We're not pitching anymore—we're placing. These aren't requests; they're confirmations. Your reputation bought us a seat at tables we used to beg to approach.

The story we tell just got a bigger megaphone.

- Sam
```

**Venue Tier Unlock (Pat's voice)**:
```
From: Patricia "Pat" Williams, PhD - Head of Distribution & Operations
Subject: Venue Network Expansion - [Tier Level] Tour Access

Logistics pipeline upgraded.

NEW VENUE ACCESS:
• [Tier Level] venues unlocked
• Average capacity: [X] attendees
• Geographic coverage: [X] markets

REVENUE PROJECTION:
Tour profitability increased [X]%. Larger venues = better margins = optimized ROI.

System ready to deploy tours at scale.

- Pat
```

**Producer Tier Unlock (D-Wave's voice)**:
```
From: Dante "D-Wave" Washington - Chief Creative Officer
Subject: Creative Frequency Upgraded - [Tier Level] Producers Available

The sonic palette just expanded.

NEW CREATIVE ACCESS:
• [Tier Level] producers
• Quality multiplier: [X]x
• Genre specializations: [List]

ARTISTIC IMPLICATIONS:
These aren't producers—they're architects of frequency. We can now sculpt sounds that were previously impossible. The universe is offering us higher-quality creative channels.

The music we make from here changes everything.

- D-Wave
```

---

#### 6. Artist Discovery Emails
**Sender**: Marcus "Mac" Rodriguez (Head of A&R)
**Trigger**: A&R Office operation completes with discovered artist

**Data Source**:
- `WeekSummary.arOffice`
- Check: `arOffice.completed === true && arOffice.discoveredArtistId !== null`
- Artist data: Fetch from artists table using `discoveredArtistId`

**Available Data**:
```typescript
{
  arOffice: {
    completed: boolean,
    sourcingType: 'active' | 'passive' | 'specialized',
    discoveredArtistId: string
  }
}
// Artist details from database:
{
  name: string,
  archetype: string,
  talent: number,
  genre: string,
  bio: string,
  signingCost: number,
  weeklyCost: number
}
```

**Email Template Concept** (Mac's voice - passionate, venue references, haunted by misses):
```
From: Marcus "Mac" Rodriguez - Head of A&R
Subject: You Need to Hear This - [Artist Name] Discovery Report

Boss, I've got a feeling about this one.

Been running [Sourcing Type] scouting this week and [Artist Name] kept showing up on my radar. [Genre] [Archetype], raw talent reading at [X]/100.

THE VIBE:
[Artist Bio]

THE NUMBERS:
• Signing Cost: $[X]
• Weekly Investment: $[X]
• Risk Profile: [Archetype]-typical

I know, I know—I said I had a feeling about [previous miss reference]. But this is different. This artist has that bridge energy I've been chasing. The kind that connects verses to choruses, you know?

My gut says move. But it's your call.

Worth a meeting?

- Mac

P.S. - If we pass on this one and they blow up somewhere else, I'm never forgiving myself. Just saying.
```

---

#### 7. Weekly Financial Report Emails
**Sender**: Finance Team (generic - CEO receives these reports)
**Trigger**: Every week advance (replaces/supplements WeekSummary)

**Data Source**:
- Full `WeekSummary` object
- `WeekSummary.expenseBreakdown`
- `WeekSummary.revenue`
- `WeekSummary.expenses`
- `WeekSummary.streams`

**Available Data**:
```typescript
{
  week: number,
  revenue: number,
  expenses: number,
  streams: number,
  expenseBreakdown: {
    weeklyOperations: number,
    artistSalaries: number,
    executiveSalaries: number,
    projectCosts: number,
    marketingCosts: number,
    roleMeetingCosts: number
  },
  financialBreakdown: string // Human-readable
}
```

**Email Template Concept** (Formal finance team tone):
```
From: Finance Department
To: CEO
Subject: Week [X] Financial Summary - P&L Report

WEEK [X] PROFIT & LOSS STATEMENT

──────────────────────────────
REVENUE: $[X]
──────────────────────────────
  Streaming Revenue    $[X]  ([Y] streams)
  Tour Revenue        $[X]
  Other Income        $[X]

──────────────────────────────
EXPENSES: $[X]
──────────────────────────────
  Artist Salaries     $[X]
  Executive Team      $[X]
  Project Costs       $[X]
  Marketing          $[X]
  Operations         $[X]
  Meetings/Other     $[X]

══════════════════════════════
NET INCOME: [+/-]$[X]
══════════════════════════════

CURRENT CASH BALANCE: $[X]
[⚠️ WARNING: Balance below $10,000 threshold - review burn rate]
[✓ Financial health nominal]

WEEK-OVER-WEEK TREND:
Revenue: [↑/↓] [X]%
Expenses: [↑/↓] [X]%
Net: [↑/↓] [X]%

- Finance Department
```

---

### Email Sender Mapping Summary

| Email Category | Sender | Role ID | Reasoning |
|----------------|--------|---------|-----------|
| Tour Completion | Patricia "Pat" Williams, PhD | `head_distribution` | Tour logistics and operations expertise |
| Top 10 Chart Debuts | Samara "Sam" Chen | `cmo` | Marketing tracks chart performance and media narratives |
| Album/Single Releases | Patricia "Pat" Williams, PhD | `head_distribution` | Distribution and streaming platform management |
| #1 Chart Debuts | Samara "Sam" Chen | `cmo` | Major PR/cultural moment requires marketing lead |
| Playlist Tier Unlocks | Patricia "Pat" Williams, PhD | `head_distribution` | Streaming/distribution expertise |
| Press Tier Unlocks | Samara "Sam" Chen | `cmo` | PR and media relationship expertise |
| Venue Tier Unlocks | Patricia "Pat" Williams, PhD | `head_distribution` | Tour venue logistics |
| Producer Tier Unlocks | Dante "D-Wave" Washington | `cco` | Creative/production oversight |
| Focus Slot Unlocks | System Notification | N/A | Mechanical game system unlock |
| Artist Discovery | Marcus "Mac" Rodriguez | `head_ar` | A&R scouting and talent discovery |
| Weekly Financial Report | Finance Team | N/A | Generic finance department (CEO receives) |

---

## Email System Architecture (Planned)

### Database Schema

**New Table**: `emails`

```typescript
{
  id: string (UUID, primary key)
  gameId: string (foreign key → games.id)
  week: number
  category: EmailCategory
  subject: string
  body: string (JSON or formatted text)
  metadata: jsonb (original event data)
  isRead: boolean (default: false)
  createdAt: timestamp
  updatedAt: timestamp
}
```

**EmailCategory Enum**:
```typescript
type EmailCategory =
  | 'tour_completion'
  | 'top_10_debut'
  | 'release'
  | 'number_one_debut'
  | 'tier_unlock'
  | 'artist_discovery'
  | 'financial_report';
```

**Indexes**:
- `gameId` (for fetching all emails for a game)
- `gameId + isRead` (for unread count queries)
- `gameId + week` (for historical lookups)

---

### Email Generation Logic

**Location**: `shared/engine/game-engine.ts` or new `shared/engine/EmailGenerator.ts`

**Integration Point**: After `processWeek()` completes, before returning `WeekSummary`

**Pseudocode**:
```typescript
function generateEmails(weekSummary: WeekSummary, gameId: string): Email[] {
  const emails: Email[] = [];

  // 1. Tour Completion Emails
  const tourCompletions = weekSummary.changes.filter(
    c => c.type === 'project_complete' && c.description.includes('tour')
  );
  tourCompletions.forEach(tour => {
    emails.push(createTourCompletionEmail(tour, weekSummary.week));
  });

  // 2. Chart Debut Emails (Top 10 + #1)
  const chartDebuts = weekSummary.chartUpdates?.filter(c => c.isDebut) || [];

  const numberOneDebuts = chartDebuts.filter(c => c.position === 1);
  numberOneDebuts.forEach(chart => {
    emails.push(createNumberOneDebutEmail(chart, weekSummary.week));
  });

  const top10Debuts = chartDebuts.filter(c => c.position <= 10 && c.position > 1);
  top10Debuts.forEach(chart => {
    emails.push(createTop10DebutEmail(chart, weekSummary.week));
  });

  // 3. Release Emails
  const releases = weekSummary.changes.filter(
    c => c.type === 'song_release' || c.type === 'release'
  );
  releases.forEach(release => {
    emails.push(createReleaseEmail(release, weekSummary.week));
  });

  // 4. Tier Unlock Emails
  const unlocks = weekSummary.changes.filter(c => c.type === 'unlock');
  const tierUnlocks = unlocks.filter(u =>
    u.description.includes('Access') ||
    u.description.includes('Tier') ||
    u.description.includes('slot')
  );
  tierUnlocks.forEach(unlock => {
    emails.push(createTierUnlockEmail(unlock, weekSummary.week));
  });

  // 5. Artist Discovery Emails
  if (weekSummary.arOffice?.completed && weekSummary.arOffice.discoveredArtistId) {
    emails.push(createArtistDiscoveryEmail(
      weekSummary.arOffice.discoveredArtistId,
      weekSummary.arOffice.sourcingType,
      weekSummary.week
    ));
  }

  // 6. Weekly Financial Report (ALWAYS generate)
  emails.push(createFinancialReportEmail(weekSummary));

  return emails;
}
```

---

### API Endpoints

**Base Path**: `/api/game/:gameId/emails`

#### GET `/api/game/:gameId/emails`
Fetch all emails for a game

**Query Params**:
- `isRead` (optional): Filter by read status (true/false)
- `category` (optional): Filter by email category
- `week` (optional): Filter by week number
- `limit` (optional): Pagination limit (default: 50)
- `offset` (optional): Pagination offset (default: 0)

**Response**:
```typescript
{
  emails: Email[],
  total: number,
  unreadCount: number
}
```

---

#### GET `/api/game/:gameId/emails/unread-count`
Get count of unread emails (for dashboard badge)

**Response**:
```typescript
{
  count: number
}
```

---

#### PATCH `/api/game/:gameId/emails/:emailId/read`
Mark email as read

**Body**:
```typescript
{
  isRead: boolean
}
```

**Response**:
```typescript
{
  success: boolean,
  email: Email
}
```

---

#### DELETE `/api/game/:gameId/emails/:emailId`
Delete email

**Response**:
```typescript
{
  success: boolean
}
```

---

### Frontend Components

#### 1. InboxWidget Component
**Location**: `client/src/components/InboxWidget.tsx` (to be created)

**Props**: None (reads from game store)

**Functionality**:
- Displays "Inbox • X Unread Emails"
- Fetches unread count via API
- Clicking opens InboxModal
- Updates in real-time when new week is processed

**Dependencies**:
- `useGameStore()` - Get current gameId
- `useQuery()` - Fetch unread count
- `useState()` - Modal open/close state

---

#### 2. InboxModal Component
**Location**: `client/src/components/InboxModal.tsx` (to be created)

**Props**:
```typescript
{
  isOpen: boolean;
  onClose: () => void;
}
```

**Functionality**:
- Two-column layout (list + viewer)
- Fetches all emails via API
- Sortable by date/subject
- Mark as read on click
- Delete button per email
- Shows email content in viewer pane

**Dependencies**:
- `useQuery()` - Fetch emails
- `useMutation()` - Mark as read / delete
- Shadcn Dialog component
- Email template renderers

---

#### 3. Email Template Renderers
**Location**: `client/src/components/email-templates/` (to be created)

**Files**:
- `TourCompletionEmail.tsx`
- `Top10DebutEmail.tsx`
- `ReleaseEmail.tsx`
- `NumberOneDebutEmail.tsx`
- `TierUnlockEmail.tsx`
- `ArtistDiscoveryEmail.tsx`
- `FinancialReportEmail.tsx`

**Each Component**:
```typescript
interface EmailTemplateProps {
  metadata: any; // Parsed from email.metadata
  week: number;
}
```

---

## Implementation Strategy

### Phase 1: Backend Foundation
**Goal**: Store emails in database, generate from game engine

**Tasks**:
1. Create `emails` table migration
2. Create email generation functions
3. Integrate email generation into `processWeek()`
4. Create API endpoints (CRUD)
5. Test email generation with existing games

**Files to Create/Modify**:
- `migrations/XXXX_create_emails_table.sql`
- `shared/engine/EmailGenerator.ts` (new)
- `shared/engine/game-engine.ts` (modify)
- `server/routes/emails.ts` (new)
- `server/index.ts` (register email routes)

---

### Phase 2: Frontend UI
**Goal**: Display emails in dashboard + modal

**Tasks**:
1. Create InboxWidget component (dashboard integration)
2. Create InboxModal component (email list + viewer)
3. Create email template components (7 templates)
4. Add API hooks for email operations
5. Style components to match game aesthetic

**Files to Create**:
- `client/src/components/InboxWidget.tsx`
- `client/src/components/InboxModal.tsx`
- `client/src/components/email-templates/[7 templates].tsx`
- `client/src/hooks/useEmails.ts` (API hooks)
- Styling updates

---

### Phase 3: Polish & Integration
**Goal**: Smooth UX, edge cases handled

**Tasks**:
1. Add loading states / skeletons
2. Add empty states ("No emails yet")
3. Add email count badges
4. Test with various game scenarios
5. Add animations / transitions
6. Performance optimization (pagination, caching)

---

## Open Implementation Questions

### 1. Email Body Format
**Options**:
- **Plain JSON**: Store structured data, render client-side
- **HTML String**: Pre-render HTML server-side
- **Markdown**: Store markdown, render client-side

**Recommendation**: Plain JSON (most flexible, easier to update templates)

### 2. Email Deduplication
**Question**: If multiple songs debut Top 10 in same week, send one email or multiple?

**Options**:
- One email per event (more detailed)
- One email per category per week (consolidated)

**Recommendation**: One email per significant event (aligns with CEO inbox realism)

### 3. Historical Chart Context
**Question**: For chart emails, include competitor context? (e.g., "You beat Song X for this spot")

**Data Available**: `ChartUpdate.isCompetitorSong` flag exists

**Recommendation**: Phase 2 feature - start simple, add context later

### 4. Email Attachments/Actions
**Question**: Should emails have interactive actions beyond Mark Read/Delete?

**Examples**:
- "View Artist Roster" button in discovery email
- "See Chart" button in chart emails

**Decision**: No actions for MVP (per user's minimal deployment strategy)

---

## Testing Strategy

### Unit Tests
- Email generation functions (each category)
- Email filtering logic (chart debuts, tier unlocks)
- API endpoint handlers

### Integration Tests
- Full week advance → email generation
- API CRUD operations
- Frontend component rendering

### Manual Testing Scenarios
1. Week with multiple events (all email types)
2. Week with no events (only financial report)
3. Deleting emails while modal is open
4. Marking emails read/unread rapidly

---

## Future Enhancements (Post-MVP)

### Email Search
- Search by subject, category, week
- Filter UI in modal

### Email Actions
- Quick links to relevant pages (artists, charts, projects)
- "Reply" mechanic for narrative depth

### Email Notifications
- Badge animation when new emails arrive
- Sound effect on email receipt

### Email Archives
- Separate "Archive" vs "Delete"
- Archive retention policy

### Narrative Depth
- Dynamic sender personalities (CFO tone vs A&R tone)
- Procedurally generated flavor text based on game state

---

## File Reference Quick List

### Existing Files (Core Dependencies)
- `shared/types/gameTypes.ts` - Type definitions (GameChange, WeekSummary, ChartUpdate)
- `shared/engine/game-engine.ts` - Event generation, processWeek()
- `shared/engine/ChartService.ts` - Chart position tracking
- `client/src/components/ToastNotification.tsx` - Current toast system
- `client/src/store/gameStore.ts` - Game state management
- `client/src/components/WeekSummary.tsx` - Current weekly summary (to be migrated)

### Files to Create (Email System)
**Backend**:
- `migrations/XXXX_create_emails_table.sql`
- `shared/engine/EmailGenerator.ts`
- `server/routes/emails.ts`
- `db/schema/emails.ts` (Drizzle schema)

**Frontend**:
- `client/src/components/InboxWidget.tsx`
- `client/src/components/InboxModal.tsx`
- `client/src/components/email-templates/TourCompletionEmail.tsx`
- `client/src/components/email-templates/Top10DebutEmail.tsx`
- `client/src/components/email-templates/ReleaseEmail.tsx`
- `client/src/components/email-templates/NumberOneDebutEmail.tsx`
- `client/src/components/email-templates/TierUnlockEmail.tsx`
- `client/src/components/email-templates/ArtistDiscoveryEmail.tsx`
- `client/src/components/email-templates/FinancialReportEmail.tsx`
- `client/src/hooks/useEmails.ts`

**Types**:
- `shared/types/emailTypes.ts` (Email, EmailCategory types)

---

## Conclusion

This document serves as the **complete reference** for implementing the email notification system in Music Label Manager. All data sources, file locations, and design decisions are documented here for future implementation phases.

**Next Steps**: Proceed with Phase 1 (Backend Foundation) once approved by project lead.
