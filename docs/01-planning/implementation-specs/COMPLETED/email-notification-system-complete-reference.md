# Email & Notification System - Complete Reference
**Status**: Planning
**Created**: 2025-09-30
**Last Updated**: 2025-09-30 (Updated with executive sender assignments and voice profiles)

---

## Overview

This document provides a comprehensive reference for all notification and email systems in Music Label Manager, including:
- Current toast notification implementation
- Planned email system architecture
- Event tracking across the game engine
- File references and data structures
- Implementation strategy

---

## System Architecture

### Design Philosophy: Hybrid Approach (Option C)

**Toasts** = Immediate feedback (ephemeral, real-time)
**Emails** = Detailed context + historical record (persistent, narrative)

- **Toasts**: Instant gratification for state changes (money, reputation, creative capital)
- **Emails**: CEO roleplay immersion with detailed reports from your team

---

## Current Toast Notification System

### File Reference
**Primary Implementation**: `client/src/components/ToastNotification.tsx`

**Dependencies**:
- `@/components/ui/toaster` - Shadcn UI toast component
- `@/components/ui/toast` - Toast primitive + actions
- `@/hooks/use-toast` - Toast state management hook
- `@/store/gameStore` - Zustand game state store

### Toast Categories (Currently Implemented)

#### 1. Real-Time State Change Toasts
**Trigger**: `useEffect` watching `gameState` changes

##### Money Changes (`client/src/components/ToastNotification.tsx:94-121`)
```typescript
// Watches: gameState.money
// Type: Revenue (positive) | Expense (negative)
// Display:
//   - Title: "üí∞ Revenue $X" or "üí∏ Expense $X"
//   - Description: Current balance + low funds warning
//   - Action: "View Budget" (if balance < $5,000)
```

**Data Source**: `gameState.money` (updated by game engine)

##### Reputation Changes (`client/src/components/ToastNotification.tsx:123-145`)
```typescript
// Watches: gameState.reputation
// Display:
//   - Title: "‚≠ê Reputation +X" or "üìâ Reputation -X"
//   - Description: Current rep + tier (Elite/Established/Rising/Emerging/Unknown)
//   - Progress: Visual bar showing reputation %
```

**Reputation Tiers**:
- Elite: 80+
- Established: 60-79
- Rising: 40-59
- Emerging: 20-39
- Unknown: 0-19

**Data Source**: `gameState.reputation` (updated by game engine)

##### Creative Capital Changes (`client/src/components/ToastNotification.tsx:147-164`)
```typescript
// Watches: gameState.creativeCapital
// Display:
//   - Title: "üí° Creative Capital +X" or "üî• Creative Capital -X"
//   - Description: Current CC + celebration if >= 80
//   - Progress: Visual bar showing CC %
```

**Data Source**: `gameState.creativeCapital` (updated by game engine)

---

#### 2. Weekly Outcome Toasts
**Trigger**: `useEffect` watching `weeklyOutcome.changes` array

##### Project Completions (`client/src/components/ToastNotification.tsx:193-213`)
```typescript
// Filter: changes.filter(c => c.type === 'project_complete')
// Display:
//   - Title: "üéµ Recording Complete!"
//   - Description: "{Project Title} songs are recorded and ready for release"
//   - Action: "View Details"
// Timing: Staggered by 1.5s per project if multiple
```

**Data Source**: `weeklyOutcome.changes[]` with `type: 'project_complete'`
**Generated By**: `shared/engine/game-engine.ts` in `processWeek()`

##### Streaming Revenue (`client/src/components/ToastNotification.tsx:215-236`)
```typescript
// Filter: changes.filter(c => c.type === 'revenue' && c.description.includes('Streaming'))
// Display:
//   - Title: "üíø Streaming Success!"
//   - Description: "Your releases generated $X from streaming this week!"
//   - Action: "View Analytics"
// Aggregation: Sums all streaming revenue changes
```

**Data Source**: `weeklyOutcome.changes[]` with `type: 'revenue'`
**Generated By**: `shared/engine/game-engine.ts` (streaming calculations)

##### Achievement/Unlock Notifications (`client/src/components/ToastNotification.tsx:238-254`)
```typescript
// Filter: changes.filter(c => c.type === 'unlock')
// Display:
//   - Title: "üèÜ New Achievement!"
//   - Description: change.description
//   - Action: "Celebrate"
```

**Data Source**: `weeklyOutcome.changes[]` with `type: 'unlock'`
**Generated By**: Multiple locations in `shared/engine/game-engine.ts`:
- Focus slot unlocks
- Tier unlocks (playlist, press, venue)
- Song recording completions

##### Artist Mood Changes (`client/src/components/ToastNotification.tsx:256-275`)
```typescript
// Filter: changes.filter(c => c.type === 'mood' && c.description.includes('meeting decision'))
// Display:
//   - Title: "üòä Artist Morale Improved" or "üòî Artist Morale Declined"
//   - Description: "Executive meeting decision boosted/lowered all artists' mood by X points"
//   - Action: "View Artists"
```

**Data Source**: `weeklyOutcome.changes[]` with `type: 'mood'`
**Generated By**: Executive meeting system (applies to all artists)

##### Artist Loyalty Changes (`client/src/components/ToastNotification.tsx:277-296`)
```typescript
// Filter: changes.filter(c => c.type === 'mood' && c.loyaltyBoost && c.description.includes('meeting decision'))
// Display:
//   - Title: "üíñ Artist Loyalty Increased" or "üíî Artist Loyalty Decreased"
//   - Description: "Executive meeting decision strengthened/weakened loyalty by X points"
//   - Action: "View Artists"
```

**Data Source**: `weeklyOutcome.changes[]` with `type: 'mood'` + `loyaltyBoost` field
**Generated By**: Executive meeting system

##### Busy Week Summary (`client/src/components/ToastNotification.tsx:298-315`)
```typescript
// Trigger: If weeklyOutcome.changes.length >= 3
// Display:
//   - Title: "üìä Busy Week!"
//   - Description: "{X} significant events occurred this week"
//   - Action: "View Summary"
```

**Data Source**: `weeklyOutcome.changes[]` array length
**Timing**: Shown 5s after weekly outcome processing

---

## Game Event Tracking System

### Core Data Types

#### GameChange Type (`shared/types/gameTypes.ts`)
```typescript
export interface GameChange {
  type: 'expense' | 'revenue' | 'meeting' | 'project_complete' | 'delayed_effect' |
        'unlock' | 'ongoing_revenue' | 'song_release' | 'release' | 'marketing' |
        'reputation' | 'error' | 'mood' | 'popularity' | 'executive_interaction' |
        'expense_tracking' | 'breakthrough' | 'awareness_gain' | 'awareness_decay';
  description: string;
  amount?: number;
  roleId?: string;
  projectId?: string;
  moodChange?: number;
  newMood?: number;
  loyaltyBoost?: number;
  newLoyalty?: number;
  source?: string;
  artistId?: string;
}
```

#### WeekSummary Type (`shared/types/gameTypes.ts`)
```typescript
export interface WeekSummary {
  week: number;
  changes: GameChange[];
  revenue: number;
  expenses: number;
  streams?: number;
  reputationChanges: Record<string, number>;
  events: EventOccurrence[];
  artistChanges?: Record<string, number>;
  expenseBreakdown?: {
    weeklyOperations: number;
    artistSalaries: number;
    executiveSalaries: number;
    projectCosts: number;
    marketingCosts: number;
    roleMeetingCosts: number;
    // ... more fields
  };
  financialBreakdown?: string;
  chartUpdates?: ChartUpdate[]; // Chart position changes
  arOffice?: {
    completed: boolean;
    sourcingType?: 'active' | 'passive' | 'specialized' | null;
    discoveredArtistId?: string | null;
  };
}
```

#### ChartUpdate Type (`shared/types/gameTypes.ts`)
```typescript
export interface ChartUpdate {
  songTitle: string;
  artistName: string;
  position: number | null;
  movement?: number; // Positive = up, negative = down
  isDebut: boolean;
  weeksOnChart?: number;
  peakPosition?: number | null;
  isCompetitorSong?: boolean;
}
```

### Event Generation Sources

#### Game Engine (`shared/engine/game-engine.ts`)
**Primary event generator** - Creates all `GameChange` objects during `processWeek()`

**Key Event Generation Locations**:

1. **Project Completions** (Recording/Tours)
   - Location: `processWeek()` ‚Üí project stage transitions
   - Type: `'project_complete'`
   - Tour completion: Lines ~800-850 (Mini-Tour handling)
   ```typescript
   changes.push({
     type: 'project_complete',
     description: `${project.title} tour completed - ${cities} cities, ${avgAttendance}% avg attendance, $${totalRevenue}`,
     amount: 0, // Revenue already counted weekly
     projectId: project.id
   });
   ```

2. **Unlock Events**
   - Focus slot unlocks (reputation thresholds)
   - Tier unlocks (playlist, press, venue access)
   - Song recording completions
   - Type: `'unlock'`
   - Location: Various points in `processWeek()`

3. **Revenue/Expense Events**
   - Streaming revenue: `'ongoing_revenue'` or `'revenue'`
   - Project costs: `'expense'`
   - Artist salaries: `'expense'`
   - Marketing costs: `'marketing'`

4. **Mood/Loyalty Changes**
   - Executive meeting decisions
   - Type: `'mood'`
   - Fields: `moodChange`, `newMood`, `loyaltyBoost`, `newLoyalty`

5. **A&R Office Discoveries**
   - Stored in: `WeekSummary.arOffice`
   - Contains: `discoveredArtistId`, `sourcingType`
   - Location: A&R Office processing logic

#### Chart Service (`shared/engine/ChartService.ts`)
**Chart position tracking** - Generates `ChartUpdate[]` array

**Chart Event Types**:
- Chart debuts (`isDebut: true`)
- Position changes (movement tracking)
- Peak position updates
- Competitor song tracking

**Integration**: Chart updates added to `WeekSummary.chartUpdates[]`

---

## Planned Email System

### Design Mockup
**Reference**: `docs/01-planning/email.PNG`

**UI Components**:
1. **Dashboard Inbox Widget** - Shows unread count, clickable to open modal
2. **Inbox Modal** - Two-column layout:
   - Left: Email list (Date/Subject sortable)
   - Right: Email content viewer
   - Actions: Mark as Read, Delete, Close (X)

### Executive Team - Email Senders ‚úÖ **IMPLEMENTED WITH SIGNATURES**
**Reference**: `data/roles.json`, `docs/01-planning/exec_team_context/Exec Team - Character Bible.md`

Your executive team will send emails based on their expertise areas:

1. **Marcus "Mac" Rodriguez** - Head of A&R (`head_ar`)
   - ‚úÖ Profile Image: `/avatars/marcus_rodriguez_exec@0.5x.png`
   - ‚úÖ Initials Fallback: MR

2. **Dante "D-Wave" Washington** - Chief Creative Officer (`cco`)
   - ‚úÖ Profile Image: `/avatars/dante_washingtong_exec@0.5x.png`
   - ‚úÖ Initials Fallback: DW

3. **Samara "Sam" Chen** - Chief Marketing Officer (`cmo`)
   - ‚úÖ Profile Image: `/avatars/samara_chen_exec@0.5x.png`
   - ‚úÖ Initials Fallback: SC

4. **Patricia "Pat" Williams, PhD** - Head of Distribution/Operations (`head_distribution`)
   - ‚úÖ Profile Image: `/avatars/patricia_williams_exec@0.5x.png`
   - ‚úÖ Initials Fallback: PW

5. **Finance Team** - Generic sender for financial reports (CEO receives these)
   - ‚úÖ No profile image - shows initials only

#### Executive Voice Profiles

**Marcus "Mac" Rodriguez (Head of A&R)**
- **Speaking Style**: Musical metaphors, venue name-dropping, obscure references
- **Mood Indicators**: References "the one that got away" when stressed
- **Email Tone**: Passionate, slightly haunted by past mistakes, eager to prove himself

**Dante "D-Wave" Washington (CCO)**
- **Speaking Style**: Synesthesia language ("sounds purple"), philosophical, mystical
- **Mood Indicators**: Quotes frequencies and "the universe"
- **Email Tone**: Artistic, pretentious but talented, talks about "sonic architecture"

**Samara "Sam" Chen (CMO)**
- **Speaking Style**: Headlines, pull quotes, war metaphors, news cycle references
- **Mood Indicators**: "Own the narrative" vs "credibility debt"
- **Email Tone**: Strategic, aggressive, frames everything as a story to control

**Patricia "Pat" Williams, PhD (Distribution/Ops)**
- **Speaking Style**: Statistics, percentages, supply chain metaphors, if-then scenarios
- **Mood Indicators**: "Systems optimized" vs "Complete system failure"
- **Email Tone**: Data-driven, analytical, uncomfortable with inefficiency

---

### Email Categories (7 Total) - Sender Assignments

#### 1. Tour Completion Emails
**Sender**: Patricia "Pat" Williams, PhD (Head of Distribution/Operations)
**Trigger**: Mini-Tour projects reach completion stage

**Data Source**:
- `WeekSummary.changes[]` with `type: 'project_complete'`
- Filter: `project.type === 'Mini-Tour'`
- Metadata: `project.metadata.tourStats`

**Available Data**:
```typescript
{
  cities: [
    { name: string, revenue: number, attendance: number }
  ],
  totalRevenue: number,
  avgAttendance: number
}
```

**Email Template Concept** (Pat's voice - data-driven, efficiency-focused):
```
From: Patricia "Pat" Williams, PhD - Head of Distribution & Operations
Subject: Tour Metrics - [Artist Name] - [City Count] Cities Completed

Tour execution complete. Here are the performance metrics:

EFFICIENCY ANALYSIS:
‚Ä¢ Cities: [X]
‚Ä¢ Total Revenue: $[X]
‚Ä¢ Average Attendance: [X]%
‚Ä¢ Optimal Performance City: [City] - $[Revenue], [X]% capacity

ROI: [Calculated percentage]
System Efficiency Rating: [X]/100

The logistics pipeline is clear for the next deployment cycle.

- Pat
```

---

#### 2. Top 10 Chart Debut Emails
**Sender**: Samara "Sam" Chen (Chief Marketing Officer)
**Trigger**: Song enters chart at position 1-10

**Data Source**:
- `WeekSummary.chartUpdates[]`
- Filter: `chartUpdate.position <= 10 && chartUpdate.isDebut === true`

**Available Data**:
```typescript
{
  songTitle: string,
  artistName: string,
  position: number,
  isDebut: boolean
}
```

**Email Template Concept** (Sam's voice - narrative framing, headline-driven):
```
From: Samara "Sam" Chen - Chief Marketing Officer
Subject: HEADLINE: "[Song]" Debuts at #[Position] - Press Cycle Activated

We're in the narrative now.

"[Artist]'s '[Song]' Crashes Top 10 at #[Position]"

That's the headline. I've already got three journalists calling for quotes and two playlist editors asking about the story behind it. This isn't just a chart position‚Äîit's a conversation starter.

STRATEGIC WINDOW: 72 hours to capitalize before the news cycle shifts.

Next move is yours, but I'd strike while we own the moment.

- Sam
```

---

#### 3. Album/Single Release Emails
**Sender**: Patricia "Pat" Williams, PhD (Head of Distribution/Operations)
**Trigger**: Song released to charts

**Data Source**:
- `WeekSummary.changes[]` with `type: 'song_release'` or `'release'`

**Available Data**:
```typescript
{
  type: 'song_release' | 'release',
  description: string,
  projectId?: string
}
```

**Email Template Concept** (Pat's voice - system status, distribution metrics):
```
From: Patricia "Pat" Williams, PhD - Head of Distribution & Operations
Subject: Release Deployed - "[Song]" by [Artist] - Systems Green

Distribution pipeline executed successfully.

RELEASE STATUS:
‚Ä¢ Track: "[Song]"
‚Ä¢ Artist: [Artist]
‚Ä¢ Platforms: All streaming services (100% uptime)
‚Ä¢ Playlist Submissions: [X] based on current access tier
‚Ä¢ Press Outlets: [X] publications notified
‚Ä¢ Metadata Quality: Verified ‚úì

Initial streaming data will populate within 24-48 hours. All systems nominal.

- Pat
```

---

#### 4. #1 Chart Debut Emails
**Sender**: Samara "Sam" Chen (Chief Marketing Officer)
**Trigger**: Song enters chart at #1 position

**Data Source**:
- `WeekSummary.chartUpdates[]`
- Filter: `chartUpdate.position === 1 && chartUpdate.isDebut === true`

**Available Data**:
```typescript
{
  songTitle: string,
  artistName: string,
  position: 1,
  isDebut: boolean
}
```

**Email Template Concept** (Sam's voice - major cultural moment framing):
```
From: Samara "Sam" Chen - Chief Marketing Officer
Subject: üèÜ CULTURAL MOMENT ACHIEVED - "[Song]" #1 DEBUT

We just made history.

"[Artist]'s '[Song]' Debuts at #1 on the Charts"

Not top 10. Not climbing. NUMBER ONE on debut.

Every major outlet is already running the story. My phone hasn't stopped. This isn't PR anymore‚Äîthis is legacy-building.

The narrative writes itself now, but we need to protect and amplify it. This moment is a weapon if we use it right.

I'm drafting the victory lap campaign. Greenlight?

- Sam

P.S. - Remember when I said we'd own the narrative? We OWN it now.
```

---

#### 5. New Tier Unlock Emails
**Sender**: Varies by tier type
**Trigger**: Reputation crosses tier threshold

**Data Source**:
- `WeekSummary.changes[]` with `type: 'unlock'`
- Filter: Description contains "Playlist Access" | "Press Access" | "Venue Access" | "Producer Tier"

**Available Data**:
```typescript
{
  type: 'unlock',
  description: string, // Contains tier name and level
  amount: 0
}
```

**Current Unlock Types & Senders**:
1. **Playlist Access** ‚Üí Patricia "Pat" Williams, PhD (Distribution)
2. **Press Access** ‚Üí Samara "Sam" Chen (CMO)
3. **Venue Access** ‚Üí Patricia "Pat" Williams, PhD (Distribution)
4. **Producer Tier** ‚Üí Dante "D-Wave" Washington (CCO)
5. **Focus Slots** ‚Üí System notification (generic)

**Email Template Concepts**:

**Playlist Tier Unlock (Pat's voice)**:
```
From: Patricia "Pat" Williams, PhD - Head of Distribution & Operations
Subject: Distribution Tier Upgrade - [Tier Level] Playlists Unlocked

System access expanded.

NEW CAPABILITIES:
‚Ä¢ [Tier Level] playlist network access
‚Ä¢ Projected reach: [X] potential listeners
‚Ä¢ Submission efficiency increased by [X]%

STRATEGIC IMPLICATIONS:
Your reputation score ([X]/100) has unlocked algorithmic partnerships with major streaming platforms. Recommendation systems will now prioritize our catalog.

ROI projection: [X]% increase in streaming revenue per release.

- Pat
```

**Press Tier Unlock (Sam's voice)**:
```
From: Samara "Sam" Chen - Chief Marketing Officer
Subject: Media Doors Opening - [Tier Level] Press Access Secured

The narrative just got louder.

NEW PRESS CONTACTS:
‚Ä¢ [Tier Level] media outlets
‚Ä¢ [X] new journalist relationships
‚Ä¢ Coverage reach: [X] million readers

WHAT THIS MEANS:
We're not pitching anymore‚Äîwe're placing. These aren't requests; they're confirmations. Your reputation bought us a seat at tables we used to beg to approach.

The story we tell just got a bigger megaphone.

- Sam
```

**Venue Tier Unlock (Pat's voice)**:
```
From: Patricia "Pat" Williams, PhD - Head of Distribution & Operations
Subject: Venue Network Expansion - [Tier Level] Tour Access

Logistics pipeline upgraded.

NEW VENUE ACCESS:
‚Ä¢ [Tier Level] venues unlocked
‚Ä¢ Average capacity: [X] attendees
‚Ä¢ Geographic coverage: [X] markets

REVENUE PROJECTION:
Tour profitability increased [X]%. Larger venues = better margins = optimized ROI.

System ready to deploy tours at scale.

- Pat
```

**Producer Tier Unlock (D-Wave's voice)**:
```
From: Dante "D-Wave" Washington - Chief Creative Officer
Subject: Creative Frequency Upgraded - [Tier Level] Producers Available

The sonic palette just expanded.

NEW CREATIVE ACCESS:
‚Ä¢ [Tier Level] producers
‚Ä¢ Quality multiplier: [X]x
‚Ä¢ Genre specializations: [List]

ARTISTIC IMPLICATIONS:
These aren't producers‚Äîthey're architects of frequency. We can now sculpt sounds that were previously impossible. The universe is offering us higher-quality creative channels.

The music we make from here changes everything.

- D-Wave
```

---

#### 6. Artist Discovery Emails
**Sender**: Marcus "Mac" Rodriguez (Head of A&R)
**Trigger**: A&R Office operation completes with discovered artist

**Data Source**:
- `WeekSummary.arOffice`
- Check: `arOffice.completed === true && arOffice.discoveredArtistId !== null`
- Artist data: Fetch from artists table using `discoveredArtistId`

**Available Data**:
```typescript
{
  arOffice: {
    completed: boolean,
    sourcingType: 'active' | 'passive' | 'specialized',
    discoveredArtistId: string
  }
}
// Artist details from database:
{
  name: string,
  archetype: string,
  talent: number,
  genre: string,
  bio: string,
  signingCost: number,
  weeklyCost: number
}
```

**Email Template Concept** (Mac's voice - passionate, venue references, haunted by misses):
```
From: Marcus "Mac" Rodriguez - Head of A&R
Subject: You Need to Hear This - [Artist Name] Discovery Report

Boss, I've got a feeling about this one.

Been running [Sourcing Type] scouting this week and [Artist Name] kept showing up on my radar. [Genre] [Archetype], raw talent reading at [X]/100.

THE VIBE:
[Artist Bio]

THE NUMBERS:
‚Ä¢ Signing Cost: $[X]
‚Ä¢ Weekly Investment: $[X]
‚Ä¢ Risk Profile: [Archetype]-typical

I know, I know‚ÄîI said I had a feeling about [previous miss reference]. But this is different. This artist has that bridge energy I've been chasing. The kind that connects verses to choruses, you know?

My gut says move. But it's your call.

Worth a meeting?

- Mac

P.S. - If we pass on this one and they blow up somewhere else, I'm never forgiving myself. Just saying.
```

---

#### 7. Weekly Financial Report Emails
**Sender**: Finance Team (generic - CEO receives these reports)
**Trigger**: Every week advance (replaces/supplements WeekSummary)

**Data Source**:
- Full `WeekSummary` object
- `WeekSummary.expenseBreakdown`
- `WeekSummary.revenue`
- `WeekSummary.expenses`
- `WeekSummary.streams`

**Available Data**:
```typescript
{
  week: number,
  revenue: number,
  expenses: number,
  streams: number,
  expenseBreakdown: {
    weeklyOperations: number,
    artistSalaries: number,
    executiveSalaries: number,
    projectCosts: number,
    marketingCosts: number,
    roleMeetingCosts: number
  },
  financialBreakdown: string // Human-readable
}
```

**Email Template Concept** (Formal finance team tone):
```
From: Finance Department
To: CEO
Subject: Week [X] Financial Summary - P&L Report

WEEK [X] PROFIT & LOSS STATEMENT

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
REVENUE: $[X]
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  Streaming Revenue    $[X]  ([Y] streams)
  Tour Revenue        $[X]
  Other Income        $[X]

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
EXPENSES: $[X]
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  Artist Salaries     $[X]
  Executive Team      $[X]
  Project Costs       $[X]
  Marketing          $[X]
  Operations         $[X]
  Meetings/Other     $[X]

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
NET INCOME: [+/-]$[X]
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

CURRENT CASH BALANCE: $[X]
[‚ö†Ô∏è WARNING: Balance below $10,000 threshold - review burn rate]
[‚úì Financial health nominal]

WEEK-OVER-WEEK TREND:
Revenue: [‚Üë/‚Üì] [X]%
Expenses: [‚Üë/‚Üì] [X]%
Net: [‚Üë/‚Üì] [X]%

- Finance Department
```

---

### Email Sender Mapping Summary

| Email Category | Sender | Role ID | Reasoning |
|----------------|--------|---------|-----------|
| Tour Completion | Patricia "Pat" Williams, PhD | `head_distribution` | Tour logistics and operations expertise |
| Top 10 Chart Debuts | Samara "Sam" Chen | `cmo` | Marketing tracks chart performance and media narratives |
| Album/Single Releases | Patricia "Pat" Williams, PhD | `head_distribution` | Distribution and streaming platform management |
| #1 Chart Debuts | Samara "Sam" Chen | `cmo` | Major PR/cultural moment requires marketing lead |
| Playlist Tier Unlocks | Patricia "Pat" Williams, PhD | `head_distribution` | Streaming/distribution expertise |
| Press Tier Unlocks | Samara "Sam" Chen | `cmo` | PR and media relationship expertise |
| Venue Tier Unlocks | Patricia "Pat" Williams, PhD | `head_distribution` | Tour venue logistics |
| Producer Tier Unlocks | Dante "D-Wave" Washington | `cco` | Creative/production oversight |
| Focus Slot Unlocks | System Notification | N/A | Mechanical game system unlock |
| Artist Discovery | Marcus "Mac" Rodriguez | `head_ar` | A&R scouting and talent discovery |
| Weekly Financial Report | Finance Team | N/A | Generic finance department (CEO receives) |

---

## Email System Architecture (Planned)

### Database Schema

**New Table**: `emails`

```typescript
{
  id: string (UUID, primary key)
  gameId: string (foreign key ‚Üí games.id)
  week: number
  category: EmailCategory
  subject: string
  body: string (JSON or formatted text)
  metadata: jsonb (original event data)
  isRead: boolean (default: false)
  createdAt: timestamp
  updatedAt: timestamp
}
```

**EmailCategory Enum**:
```typescript
type EmailCategory =
  | 'tour_completion'
  | 'top_10_debut'
  | 'release'
  | 'number_one_debut'
  | 'tier_unlock'
  | 'artist_discovery'
  | 'financial_report';
```

**Indexes**:
- `gameId` (for fetching all emails for a game)
- `gameId + isRead` (for unread count queries)
- `gameId + week` (for historical lookups)

---

### Email Generation Logic

**Location**: `shared/engine/game-engine.ts` or new `shared/engine/EmailGenerator.ts`

**Integration Point**: After `processWeek()` completes, before returning `WeekSummary`

**Pseudocode**:
```typescript
function generateEmails(weekSummary: WeekSummary, gameId: string): Email[] {
  const emails: Email[] = [];

  // 1. Tour Completion Emails
  const tourCompletions = weekSummary.changes.filter(
    c => c.type === 'project_complete' && c.description.includes('tour')
  );
  tourCompletions.forEach(tour => {
    emails.push(createTourCompletionEmail(tour, weekSummary.week));
  });

  // 2. Chart Debut Emails (Top 10 + #1)
  const chartDebuts = weekSummary.chartUpdates?.filter(c => c.isDebut) || [];

  const numberOneDebuts = chartDebuts.filter(c => c.position === 1);
  numberOneDebuts.forEach(chart => {
    emails.push(createNumberOneDebutEmail(chart, weekSummary.week));
  });

  const top10Debuts = chartDebuts.filter(c => c.position <= 10 && c.position > 1);
  top10Debuts.forEach(chart => {
    emails.push(createTop10DebutEmail(chart, weekSummary.week));
  });

  // 3. Release Emails
  const releases = weekSummary.changes.filter(
    c => c.type === 'song_release' || c.type === 'release'
  );
  releases.forEach(release => {
    emails.push(createReleaseEmail(release, weekSummary.week));
  });

  // 4. Tier Unlock Emails
  const unlocks = weekSummary.changes.filter(c => c.type === 'unlock');
  const tierUnlocks = unlocks.filter(u =>
    u.description.includes('Access') ||
    u.description.includes('Tier') ||
    u.description.includes('slot')
  );
  tierUnlocks.forEach(unlock => {
    emails.push(createTierUnlockEmail(unlock, weekSummary.week));
  });

  // 5. Artist Discovery Emails
  if (weekSummary.arOffice?.completed && weekSummary.arOffice.discoveredArtistId) {
    emails.push(createArtistDiscoveryEmail(
      weekSummary.arOffice.discoveredArtistId,
      weekSummary.arOffice.sourcingType,
      weekSummary.week
    ));
  }

  // 6. Weekly Financial Report (ALWAYS generate)
  emails.push(createFinancialReportEmail(weekSummary));

  return emails;
}
```

---

### API Endpoints

**Base Path**: `/api/game/:gameId/emails`

#### GET `/api/game/:gameId/emails`
Fetch all emails for a game

**Query Params**:
- `isRead` (optional): Filter by read status (true/false)
- `category` (optional): Filter by email category
- `week` (optional): Filter by week number
- `limit` (optional): Pagination limit (default: 50)
- `offset` (optional): Pagination offset (default: 0)

**Response**:
```typescript
{
  emails: Email[],
  total: number,
  unreadCount: number
}
```

---

#### GET `/api/game/:gameId/emails/unread-count`
Get count of unread emails (for dashboard badge)

**Response**:
```typescript
{
  count: number
}
```

---

#### PATCH `/api/game/:gameId/emails/:emailId/read`
Mark email as read

**Body**:
```typescript
{
  isRead: boolean
}
```

**Response**:
```typescript
{
  success: boolean,
  email: Email
}
```

---

#### DELETE `/api/game/:gameId/emails/:emailId`
Delete email

**Status**: ‚úÖ **IMPLEMENTED** (Backend + Frontend)

**Response**:
```typescript
{
  success: boolean
}
```

**Frontend Implementation**:
- Hook: `useDeleteEmail()` in `client/src/hooks/useEmails.ts`
- UI: Delete button with confirmation dialog in `InboxModal.tsx`
- Uses Shadcn AlertDialog for confirmation
- Automatic cache invalidation on success
- Smart email selection after deletion (next/previous/null)

---

### Frontend Components

#### 1. InboxWidget Component
**Location**: `client/src/components/InboxWidget.tsx` ‚úÖ **CREATED**

**Props**: None (reads from game store)

**Functionality**:
- ‚úÖ Displays "Inbox ‚Ä¢ X Unread Emails"
- ‚úÖ Fetches unread count via API
- ‚úÖ Clicking opens InboxModal
- ‚úÖ Updates in real-time when new week is processed
- ‚úÖ Shows latest 2 emails preview
- ‚úÖ "Open inbox" button

**Dependencies**:
- `useGameStore()` - Get current gameId
- `useEmails()` - Fetch emails with limit
- `useUnreadEmailCount()` - Fetch unread count
- `useState()` - Modal open/close state

---

#### 2. InboxModal Component
**Location**: `client/src/components/InboxModal.tsx` ‚úÖ **CREATED**

**Props**:
```typescript
{
  open: boolean;
  onOpenChange: (open: boolean) => void;
  initialEmailId?: string | null;
}
```

**Functionality**:
- ‚úÖ Two-column layout (list + viewer)
- ‚úÖ Fetches all emails via API with filtering
- ‚úÖ Category filter dropdown (All/Chart/Financial/Artist/A&R)
- ‚úÖ Unread-only toggle switch
- ‚úÖ Mark as read/unread toggle per email
- ‚úÖ **Delete button with confirmation dialog** ‚úÖ **NEW**
- ‚úÖ Shows email content in viewer pane with template rendering
- ‚úÖ Refresh button for manual sync
- ‚úÖ Smart email selection after deletion

**Dependencies**:
- `useEmails()` - Fetch emails with filtering
- `useUnreadEmailCount()` - Fetch unread count
- `useMarkEmailRead()` - Mark as read mutation
- `useDeleteEmail()` - Delete email mutation ‚úÖ **NEW**
- Shadcn Dialog component
- Shadcn AlertDialog component (for delete confirmation) ‚úÖ **NEW**
- Email template renderers (AREmail, ChartEmail, ArtistEmail, FinancialEmail)

---

#### 3. Email Template Renderers
**Location**: `client/src/components/email-templates/` ‚úÖ **CREATED**

**Files**:
- ‚úÖ `TourCompletionEmail.tsx`
- ‚úÖ `Top10DebutEmail.tsx`
- ‚úÖ `ReleaseEmail.tsx`
- ‚úÖ `NumberOneDebutEmail.tsx`
- ‚úÖ `TierUnlockEmail.tsx`
- ‚úÖ `ArtistDiscoveryEmail.tsx`
- ‚úÖ `FinancialReportEmail.tsx`
- ‚úÖ `ArtistSigningEmail.tsx`
- ‚úÖ **`EmailSignature.tsx`** - Reusable signature block component ‚úÖ **NEW (2025-10-06)**

**EmailSignature Component**:
```typescript
interface EmailSignatureProps {
  sender: string;
  senderRoleId?: string | null;
}
```

**Features**:
- ‚úÖ Shadcn Avatar component with executive profile images
- ‚úÖ Executive profiles mapped: Mac (A&R), Sam (CMO), Pat (Distribution), D-Wave (CCO)
- ‚úÖ Displays name, title, and avatar with brand styling
- ‚úÖ Fallback initials when no image available
- ‚úÖ Integrated into all 7+ email templates

**Each Template Component**:
```typescript
interface EmailTemplateProps {
  email: EmailRecord<Record<string, unknown>>;
}
```

**All templates now include**:
```tsx
<EmailSignature sender={email.sender} senderRoleId={email.senderRoleId} />
```

**Signature Block Visual Design**:
```tsx
<div className="mt-6 pt-4 border-t border-white/10">
  <div className="flex items-center gap-3">
    <Avatar className="h-10 w-10 ring-2 ring-brand-purple/50">
      <AvatarImage src={profile.image} alt={sender} />
      <AvatarFallback className="bg-brand-mauve text-white text-sm font-semibold">
        {profile.initials}
      </AvatarFallback>
    </Avatar>
    <div>
      <p className="text-sm font-semibold text-white">{sender}</p>
      <p className="text-xs text-white/60">{profile.title}</p>
    </div>
  </div>
</div>
```

**Signature Examples**:
- **Mac (A&R)**: Avatar + "Marcus 'Mac' Rodriguez" + "Head of A&R"
- **Sam (CMO)**: Avatar + "Samara 'Sam' Chen" + "Chief Marketing Officer"
- **Pat (Distribution)**: Avatar + "Patricia 'Pat' Williams, PhD" + "Head of Distribution & Operations"
- **D-Wave (CCO)**: Avatar + "Dante 'D-Wave' Washington" + "Chief Creative Officer"
- **Finance**: Initials only (no avatar) + "Finance Department"

---

## Implementation Strategy

### Phase 1: Backend Foundation ‚úÖ **COMPLETE**
**Goal**: Store emails in database, generate from game engine

**Tasks**:
1. ‚úÖ Create `emails` table migration
2. ‚úÖ Create email generation functions
3. ‚úÖ Integrate email generation into `processWeek()`
4. ‚úÖ Create API endpoints (CRUD)
5. ‚úÖ Test email generation with existing games

**Files Created/Modified**:
- ‚úÖ `migrations/0015_create_emails_table.sql` (created)
- ‚úÖ `migrations/0016_consolidate_email_categories.sql` (created)
- ‚úÖ `shared/engine/EmailGenerator.ts` (created)
- ‚úÖ `shared/engine/game-engine.ts` (modified - integrated email generation)
- ‚úÖ `server/routes.ts` (modified - added email endpoints)
- ‚úÖ `server/storage.ts` (modified - added email CRUD methods)

---

### Phase 2: Frontend UI ‚úÖ **COMPLETE**
**Goal**: Display emails in dashboard + modal

**Tasks**:
1. ‚úÖ Create InboxWidget component (dashboard integration)
2. ‚úÖ Create InboxModal component (email list + viewer)
3. ‚úÖ Create email template components (8 templates)
4. ‚úÖ Add API hooks for email operations
5. ‚úÖ Style components to match game aesthetic
6. ‚úÖ **Add delete functionality with confirmation dialog** (Update 2025-10-06)

**Files Created**:
- ‚úÖ `client/src/components/InboxWidget.tsx`
- ‚úÖ `client/src/components/InboxModal.tsx` (includes delete button + AlertDialog)
- ‚úÖ `client/src/components/email-templates/AREmail.tsx`
- ‚úÖ `client/src/components/email-templates/ArtistEmail.tsx`
- ‚úÖ `client/src/components/email-templates/ChartEmail.tsx`
- ‚úÖ `client/src/components/email-templates/FinancialEmail.tsx`
- ‚úÖ `client/src/components/email-templates/ArtistDiscoveryEmail.tsx`
- ‚úÖ `client/src/components/email-templates/ArtistSigningEmail.tsx`
- ‚úÖ `client/src/components/email-templates/TourCompletionEmail.tsx`
- ‚úÖ `client/src/components/email-templates/Top10DebutEmail.tsx`
- ‚úÖ `client/src/components/email-templates/NumberOneDebutEmail.tsx`
- ‚úÖ `client/src/components/email-templates/ReleaseEmail.tsx`
- ‚úÖ `client/src/components/email-templates/TierUnlockEmail.tsx`
- ‚úÖ `client/src/components/email-templates/FinancialReportEmail.tsx`
- ‚úÖ **`client/src/components/email-templates/EmailSignature.tsx`** - Executive signature block (2025-10-06)
- ‚úÖ `client/src/hooks/useEmails.ts` (includes useEmails, useUnreadEmailCount, useMarkEmailRead, **useDeleteEmail**)

---

### Phase 3: Polish & Integration ‚úÖ **MOSTLY COMPLETE**
**Goal**: Smooth UX, edge cases handled

**Tasks**:
1. ‚úÖ Add loading states / skeletons (LoadingList component)
2. ‚úÖ Add empty states ("No emails yet")
3. ‚úÖ Add email count badges (unread badge in widget + modal header)
4. ‚úÖ Test with various game scenarios
5. ‚è≥ Add animations / transitions (basic, could be enhanced)
6. ‚úÖ Performance optimization (pagination limit 50, React Query caching, memoized params)

**Additional Polish Completed (2025-10-06)**:
7. ‚úÖ Delete functionality with confirmation dialog
8. ‚úÖ Smart email selection after deletion
9. ‚úÖ Category filtering (All/Chart/Financial/Artist/A&R)
10. ‚úÖ Unread-only toggle
11. ‚úÖ Refresh button
12. ‚úÖ Responsive two-pane layout
13. ‚úÖ **Executive signature blocks with Shadcn Avatar components** (2025-10-06)
14. ‚úÖ **Profile images for all executives (Mac, Sam, Pat, D-Wave)** (2025-10-06)

---

## Implementation Decisions ‚úÖ **RESOLVED**

### 1. Email Body Format ‚úÖ **IMPLEMENTED**
**Decision**: Plain JSON (most flexible, easier to update templates)

**Implementation**:
- ‚úÖ Backend stores structured JSON in `body` field
- ‚úÖ Frontend renders via template components (AREmail, ChartEmail, ArtistEmail, FinancialEmail)
- ‚úÖ Metadata field stores additional context

### 2. Email Deduplication ‚úÖ **IMPLEMENTED**
**Decision**: One email per significant event (aligns with CEO inbox realism)

**Implementation**:
- ‚úÖ Each chart debut gets separate email
- ‚úÖ Each tour completion gets separate email
- ‚úÖ Each tier unlock gets separate email
- ‚úÖ Financial report always generated (one per week)

### 3. Historical Chart Context ‚è≥ **DEFERRED TO FUTURE**
**Decision**: Start simple, add context later

**Current State**:
- `ChartUpdate.isCompetitorSong` flag exists in data
- Not yet displayed in email templates
- Future enhancement opportunity

### 4. Email Actions ‚úÖ **PARTIALLY IMPLEMENTED**
**Current Actions**:
- ‚úÖ Mark as read/unread
- ‚úÖ Delete (with confirmation)
- ‚úÖ Category filtering
- ‚úÖ Unread-only toggle

**Future Enhancement**:
- Deep links to artist roster, charts, projects (deferred)

---

## Testing Strategy

### Unit Tests
- Email generation functions (each category)
- Email filtering logic (chart debuts, tier unlocks)
- API endpoint handlers

### Integration Tests
- Full week advance ‚Üí email generation
- API CRUD operations
- Frontend component rendering

### Manual Testing Scenarios
1. Week with multiple events (all email types)
2. Week with no events (only financial report)
3. Deleting emails while modal is open
4. Marking emails read/unread rapidly

---

## Future Enhancements (Post-MVP)

### Email Search
- Search by subject, category, week
- Filter UI in modal

### Email Actions
- Quick links to relevant pages (artists, charts, projects)
- "Reply" mechanic for narrative depth

### Email Notifications
- Badge animation when new emails arrive
- Sound effect on email receipt

### Email Archives
- Separate "Archive" vs "Delete"
- Archive retention policy

### Narrative Depth
- Dynamic sender personalities (CFO tone vs A&R tone)
- Procedurally generated flavor text based on game state

---

## File Reference Quick List

### Existing Files (Core Dependencies)
- `shared/types/gameTypes.ts` - Type definitions (GameChange, WeekSummary, ChartUpdate)
- `shared/engine/game-engine.ts` - Event generation, processWeek()
- `shared/engine/ChartService.ts` - Chart position tracking
- `client/src/components/ToastNotification.tsx` - Current toast system
- `client/src/store/gameStore.ts` - Game state management
- `client/src/components/WeekSummary.tsx` - Current weekly summary (to be migrated)

### Files to Create (Email System)
**Backend**:
- `migrations/XXXX_create_emails_table.sql`
- `shared/engine/EmailGenerator.ts`
- `server/routes/emails.ts`
- `db/schema/emails.ts` (Drizzle schema)

**Frontend**:
- `client/src/components/InboxWidget.tsx`
- `client/src/components/InboxModal.tsx`
- `client/src/components/email-templates/TourCompletionEmail.tsx`
- `client/src/components/email-templates/Top10DebutEmail.tsx`
- `client/src/components/email-templates/ReleaseEmail.tsx`
- `client/src/components/email-templates/NumberOneDebutEmail.tsx`
- `client/src/components/email-templates/TierUnlockEmail.tsx`
- `client/src/components/email-templates/ArtistDiscoveryEmail.tsx`
- `client/src/components/email-templates/FinancialReportEmail.tsx`
- `client/src/hooks/useEmails.ts`

**Types**:
- `shared/types/emailTypes.ts` (Email, EmailCategory types)

---

## Conclusion

This document serves as the **complete reference** for implementing the email notification system in Music Label Manager. All data sources, file locations, and design decisions are documented here for future implementation phases.

**Next Steps**: Proceed with Phase 1 (Backend Foundation) once approved by project lead.
